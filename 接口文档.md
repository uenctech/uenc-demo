# 接口文档

## 一、网络请求规范

1. 所有网络请求需按照协议规范（数据格式）将数据组织好后，使用socket连接方式发送到主网节点，当主网节点收到请求后将按照同样协议规范（数据格式）返回给请求方，请求方需自行解析相关数据获得接口返回信息。

2. 请求协议中部分信息是以protobuf方式进行封装，封装后序列化后填充请求协议中进行发送。一般请求协议的名称以Req结尾，发送到主网后，主网后会返回Ack结尾的protobuf数据体进行回应。例如请求获得余额的子协议接口为GetAmountReq，则主网服务器收到该请求后的回应数据体为GetAmountAck。

3. 请求协议的数据格式如下：

   | 协议总长度 |     通用协议     | 校验和 | 结束标志位 |
   | :--------: | :--------------: | :----: | :--------: |
   |   4bytes   | 序列化后的字符串 | 4bytes |   4bytes   |

   - 协议总长度

     - 该字段4字节，记录接下来的“通用协议”+“校验和”+“结束标记”的总长度。假设通用协议100个字节，校验和4个字节，结束标记4个字节，则总长度为100 + 4 + 4 = 108字节。

   - 通用协议

     - 通用协议为profobuf格式，原型如下：

       ```
       message CommonMsg {
       	string version        = 1;
       	string type           = 2;
       	int32 encrypt         = 3;
       	int32 compress        = 4;
       	bytes data            = 5;
       }
       ```

       |   字段   |                             说明                             |
       | :------: | :----------------------------------------------------------: |
       | version  |                     版本号                    				 |
       |   type   | 子协议类型名称，根据实际业务需要填充接口名称，如”GetAmountReq” |
       | encrypt  |            是否加密，1为加密，0为不加密，默认为0             |
       | compress |            是否压缩，1为压缩，0为不压缩，默认为0             |
       |   data   | 子协议接口protobuf数据体序列化后的数据,请求时需要将子协议接口的protobuf类型数据序列化后，填充到data中后进行发送。 |

   - 校验和

     - 校验和长度为4字节，是通用协议序列化后，通过Adler32算法计算出来的校验和信息。

   - 结束标志位

     - 结束标记长度为4字节，其内容为7777777。

4. 将请求协议发送到主网后，主网也按照请求协议格式封装回传信息传送给请求方，请求方收到信息后：

   1. 根据协议总长度获得完整回传信息。
   2. 根据协议总长度获得通用协议、校验和以及结束标记。
   3. 根据校验和判断通用协议是否完整。
   4. 通过反序列化通用协议，获取子协议（接口）名称和子协议（接口）的数据内容。
   5. 根据通用协议中的压缩和加密字段，确定是否对子协议（接口）的数据内容进行解压缩或解密操作。
   6. 将子协议的数据内容按照子协议的protobuf格式进行反序列化，获得完整的子协议（接口）请求内容。



##  二、设置设备密码接口（SetDevPasswordReq）

1. 请求

   ```
   message SetDevPasswordReq 
   {
       string version 	= 1;
       string old_pass = 2;
       string new_pass = 3;
   }
   ```

   |   字段   |         说明         |
   | :------: | :------------------: |
   | version  |        版本号        |
   | old_pass |        旧密码        |
   | new_pass |        新密码        |

2. 响应

   ```
   message SetDevPasswordAck 
   {
       string version 		= 1;
       sint32 code 		= 2;
       string description 	= 3;
   }
   ```

   |    字段     |                             说明                             |
   | :---------: | :----------------------------------------------------------: |
   |   version   |                         版本号                               |
   |    code     | 0成功; -1参数错误; -2 密码不能为空; -3旧密码非法（特殊字符或长度超过8个字节）; -4 新密码非法（特殊字符或长度超过8个字节）; -5 新旧密码不能相同; -6 旧密码验证不正确; -7 未知错误 |
   | description |                       返回值的文字描述                       |



##  三、设置矿工费请求接口（SetServiceFeeReq）

1. 请求

   ```
   message SetServiceFeeReq
   {
   	string version 				= 1;			
   	string password				= 2;					
   	string service_fee 			= 3;					
   }
   ```

   |    字段     |         说明         |
   | :---------: | :------------------: |
   |   version   | 		版本号          |
   |  password   |       矿机密码       |
   | service_fee |        设定值        |

2. 响应

   ```
   message SetServiceFeeAck
   {
   	string version 				= 1;				
   	sint32  code 				= 2;					
   	string description 			= 3;					
   }
   ```

   |    字段     |                   说明                    |
   | :---------: | :---------------------------------------: |
   |   version   |           		版本号                   |
   |    code     | 0成功; -6 密码错误; -7 滑动条数值显示错误 |
   | description |             返回值的文字描述              |



##  四、获取账户余额接口（GetAmountReq）

1. 请求

   ```
   message GetAmountReq 
   {
       string version = 1;
       string address = 2;
   }
   ```

   |  字段   |         说明         |
   | :-----: | :------------------: |
   | version | 		  版本号        |
   | address |       钱包地址       |

2. 响应

   ```
   message GetAmountAck 
   {
       string version 		= 1;
       sint32 code 		= 2;
       string description 	= 3;
   
       string address 		= 4;
       string balance 		= 5;
   }
   ```

   |    字段     |              说明               |
   | :---------: | :-----------------------------: |
   |   version   |      		版本号             |
   |    code     | 返回0为成功, -1为钱包地址不可用 |
   | description |        返回值的文字描述         |
   |   address   |            钱包地址             |
   |   balance   |              余额               |



##  五、获取特定节点打包费接口（GetPacketFeeReq）

1. 请求

   ```
   message GetPacketFeeReq 
   {
   	string version				= 1;					
   	string password				= 2;					
   	string public_net_ip		= 3;						
   }
   ```

   |     字段      |         说明         |
   | :-----------: | :------------------: |
   |    version    |       版本号         |
   |   password    |       矿机密码       |
   | public_net_ip | 当前连接的的公网的ip |

2. 响应

   ```
   message GetPacketFeeAck 
   {
       string version 				= 1;
       sint32 code 				= 2;
       string description 			= 3;
   
       string packet_fee 			= 4;
   }
   ```

   |    字段     |         说明         |
   | :---------: | :------------------: |
   |   version   | 		  版本号        |
   |    code     |        0成功         |
   | description |   返回值的文字描述   |
   | packet_fee  |        打包费        |


##  六、根据密码获取钱包地址接口（GetDevPasswordReq）

1. 请求

   ```
   message GetDevPasswordReq 
   {
       string version 	= 1;
       string password = 2;
   }
   ```

   |   字段   |         说明         |
   | :------: | :------------------: |
   | version  | 		版本号 		 |
   | password |         密码         |

2. 响应

   ```
   message GetDevPasswordAck 
   {
       string version 		= 1;
       sint32 code 		= 2;
       string description 	= 3;
   
       string address 		= 4;
   }
   ```

   |    字段     |         说明         |
   | :---------: | :------------------: |
   |   version   |       版本号         |
   |    code     |  0成功; -2 密码错误  |
   | description |   返回值的文字描述   |
   |   address   |       钱包地址       |
   
   
   

##  七、获取平均手续费、同步状态等信息接口（GetServiceInfoReq）

1. 请求

   ```
   message GetServiceInfoReq
   {
   	string version 			= 1;
   	string password 		= 2;	
   	string public_net_ip 	= 3;
    bool is_show 			= 4;
	uint32      sequence_number         = 5;                       
   }
   ```

   |     字段      |                         说明                          |
   | :-----------: | :---------------------------------------------------: |
   |    version    |                 版本号                                |
   |   password    |               手机端密码(暂时不需要传)                |
   | public_net_ip |                      公网节点IP                       |
   |    is_show    | 非直连(通过矿机)公网节点 需要传true(club可忽视此参数) |
   |sequence_number|  请求的序列号 (请求的时候传入什么值就会返回什么值)    |
2. 响应

   ```
   message GetServiceInfoAck
   {
   	string version 							= 1;
       sint32 code 							= 2;
       string description 						= 3;
   	string mac_hash 						= 4;
   	string device_version 					= 5;
   	repeated ServiceFee service_fee_info 	= 6;
   
   	enum SyncStatus
   	{
   		TRUE 	= 0;
   		FALSE 	= 1;
   		FAIL 	= -1;	
   	}
   
   	SyncStatus   is_sync 					= 7;
	sint32       height          = 8;                       //矿机高度
    uint32       sequence        = 9;                        //回应的序列号
   }
   message ServiceFee
   {
   	string max_fee 		= 1;
   	string min_fee 		= 2;
   	string service_fee 	= 3;
    string avg_fee 		= 4;
   }
   ```

   |       字段       |                            说明                             |
   | :--------------: | :---------------------------------------------------------: |
   |     version      |                    			版本号                  		|
   |       code       |   0为成功; -1 版本错误返回值的文字描述; -404 连接公网超时   |
   |   description    |                          返回描述                           |
   |     mac_hash     |                            废弃                             |
   |  device_version  |                        矿机程序版本                         |
   | service_fee_info |                   ServiceFee 手续费结构体                   |
   |     is_sync      |                  SyncStatus 是否同步枚举值                  |
   |    SyncStatus    |      0 与主网同步; 1 与主网未同步; -1 获得主网信息失败      |
   |     max_fee      |                     前一百块交易最大值                      |
   |     min_fee      |                     前一百块交易最小值                      |
   |   service_fee    |                       矿工设置的矿费                        |
   |     avg_fee      |                     前一百块交易平均值                      |
   |    SyncStatus    | 0 矿机与主网已同步; 1 矿机与主网未同步; -1 获取主网信息失败 |
   |     height       |    矿机高度或者公网高度(请求的是矿机就是矿机高度，请求的是公网就是公网高度)|                                                         |
   | sequence         |      请求端传入的序列号(请求端传入什么数据返回什么数据)|


## 八、查询块信息接口（GetBlockInfoReq）

1. 请求

   ```
   message GetBlockInfoReq 
   {
       string version = 1;
       sint32 height = 2;
       sint32 count = 3;
   }
   ```

   |  字段   |         说明         |
   | :-----: | :------------------: |
   | version |         版本号       |
   | height  |         高度         |
   |  count  |  一共需要查询的块数  |

2. 响应

   ```
   message GetBlockInfoAck {
       string version 						= 1;
       sint32 code 						= 2;
       string description 					= 3;
   
       //data
       uint64 top 							= 4; 
       repeated BlockInfo block_info_list 	= 5;
       uint64 tx_count 					= 6; 
   }
   message BlockInfo 
   {
       sint32 height 						= 1;
       string hash_merkle_root 			= 2;
       string hash_prev_block 				= 3;
       string block_hash 					= 4;
       uint64 ntime 						= 5;
       repeated TxInfo tx_info_list 		= 6;
       string packet_fee 					= 7;
       string packet_ip 					= 8;
   }
   message TxInfo 
   {
       string tx_hash 						= 1;
       repeated string transaction_signer 	= 2;
       repeated TxVinInfo vin_list 		= 3;
       repeated TxVoutInfo vout_list 		= 4;
       uint64 nlock_time 					= 5;
       string stx_owner 					= 6;
       uint64 stx_owner_index 				= 7;
       uint32 version 						= 8;
   }
   message TxVinInfo 
   {
       string script_sig 					= 1;
       string pre_vout_hash 				= 2;
       uint64 pre_vout_index 				= 3;
   }
   message TxVoutInfo 
   {
       string script_pubkey 				= 1;
       string amount 						= 2;
   }
   ```

   |        字段        |               说明                |
   | :----------------: | :-------------------------------: |
   |      version       |              版本号               |
   |        code        |              返回值               |
   |    description     |             返回描述              |
   |        top         |              块高度               |
   |  block_info_list   |     BlockInfo块信息结构体数组     |
   |      tx_count      |              交易数               |
   |       height       |              块高度               |
   |  hash_merkle_root  |             merkle值              |
   |  hash_prev_block   |           上一个块hash            |
   |     block_hash     |              块hash               |
   |       ntime        |             建块时间              |
   |    tx_info_list    |     TxInfo 交易信息结构体数组     |
   |     packet_fee     |              打包费               |
   |     packet_ip      |           打包费节点ip            |
   |      tx_hash       |             交易hash              |
   | transaction_signer |             交易签名              |
   |      vin_list      |  TxVinInfo 交易vin信息结构体数组  |
   |     vout_list      | TxVoutInfo 交易vout信息结构体数组 |
   |     nlock_time     |             建块时间              |
   |     stx_owner      |          交易方钱包地址           |
   |  stx_owner_index   |       交易方钱包地址索引号        |
   |      version       |            交易版本号             |
   |     script_sig     |               签名                |
   |   pre_vout_hash    |             vout hash             |
   |   pre_vout_index   |           vout hash索引           |
   |   script_pubkey    |             钱包地址              |
   |       amount       |               金额                |



##  九、根据钱包地址查询交易信息接口（GetAddrInfoReq）

1. 请求

   ```
   message GetAddrInfoReq 
   {
       string version 	= 1;
       string address 	= 2;
       uint32 index 	= 3;
       uint32 count 	= 4;
   }
   ```

   |  字段   |              说明              |
   | :-----: | :----------------------------: |
   | version |      		版本号            |
   | address |            钱包地址            |
   |  index  | 查询第一个块的索引(第一次传-1) |
   |  count  |       一共需要查询的块数       |

2. 响应

   ```
   message GetAddrInfoAck {
       string version 						= 1;
       sint32 code 						= 2;
       string description 					= 3;
       uint64 total 						= 4;
       repeated BlockInfo block_info_list 	= 5;
   }
   message BlockInfo 
   {
       sint32 height 						= 1;
       string hash_merkle_root 			= 2;
       string hash_prev_block 				= 3;
       string block_hash 					= 4;
       uint64 ntime 						= 5;
       repeated TxInfo tx_info_list 		= 6;
       string packet_fee 					= 7;
       string packet_ip 					= 8;
   }
   message TxInfo 
   {
       string tx_hash 						= 1;
       repeated string transaction_signer 	= 2;
       repeated TxVinInfo vin_list 		= 3;
       repeated TxVoutInfo vout_list 		= 4;
       uint64 nlock_time 					= 5;
       string stx_owner 					= 6;
       uint64 stx_owner_index 				= 7;
       uint32 version 						= 8;
   }
   message TxVinInfo 
   {
       string script_sig 					= 1;
       string pre_vout_hash 				= 2;
       uint64 pre_vout_index 				= 3;
   }
   message TxVoutInfo 
   {
       string script_pubkey 				= 1;
       string amount 						= 2;
   }
   ```

   |        字段        |                           说明                            |
   | :----------------: | :-------------------------------------------------------: |
   |      version       |                   		版本号                    		|
   |        code        | 0 为成功; -1 获取失败 没有交易块产生; -2 起始索引超出范围 |
   |    description     |                         返回描述                          |
   |       total        |                         返回总数                          |
   |  block_info_list   |                 BlockInfo块信息结构体数组                 |
   |       height       |                          块高度                           |
   |  hash_merkle_root  |                         merkle值                          |
   |  hash_prev_block   |                       上一个块hash                        |
   |     block_hash     |                          块hash                           |
   |       ntime        |                         建块时间                          |
   |    tx_info_list    |                 TxInfo 交易信息结构体数组                 |
   |     packet_fee     |                          打包费                           |
   |     packet_ip      |                       打包费节点ip                        |
   |      tx_hash       |                         交易hash                          |
   | transaction_signer |                         交易签名                          |
   |      vin_list      |              TxVinInfo 交易vin信息结构体数组              |
   |     vout_list      |             TxVoutInfo 交易vout信息结构体数组             |
   |     nlock_time     |                         建块时间                          |
   |     stx_owner      |                      交易方钱包地址                       |
   |  stx_owner_index   |                   交易方钱包地址索引号                    |
   |      version       |                        交易版本号                         |
   |     script_sig     |                           签名                            |
   |   pre_vout_hash    |                         vout hash                         |
   |   pre_vout_index   |                       vout hash索引                       |
   |   script_pubkey    |                         钱包地址                          |
   |       amount       |                           金额                            |



##  十、获得交易信息列表请求（GetTxInfoListReq）

1. 请求

   ```
   message GetTxInfoListReq
   {
       string version 			= 1; 
       string addr 			= 2; 
       uint32 index 			= 3; 
       uint32 count 			= 4; 
   }
   ```

   |  字段   |   说明   |
   | :-----: | :------: |
   | version |  版本号  |
   |  addr   |   地址   |
   |  index  |   索引   |
   |  count  | 查询数量 |

2. 响应

   ```
   message GetTxInfoListAck
   {
       string version 				= 1;
       int32 code 					= 2;
       string description 			= 3;
       repeated TxInfoItem list 	= 4; 
       uint32 total 				= 5; 
   }
   message TxInfoItem
   {
       TxInfoType type 			= 1;
       string txhash 				= 2; 
       uint64 time 				= 3; 
       string amount 				= 4; 
   }
   enum TxInfoType {
       TxInfoType_Unknown 			= 0;
       TxInfoType_Originator 		= 1; 
       TxInfoType_Receiver  		= 2; 
       TxInfoType_Gas 				= 3;
       TxInfoType_Award 			= 4; 
       TxInfoType_Pledge 			= 5;
       TxInfoType_RedeemPledge 	= 6; 
   }
   ```

   |          字段           |                             说明                             |
   | :---------------------: | :----------------------------------------------------------: |
   |         version         |                            版本号                            |
   |          code           | 返回错误码 0 成功; -1 地址长度不正确; -2 获得交易信息失败; -3 该地址无交易信息; -4 索引越界; -5 获得交易信息错误; |
   |       description       |                         返回错误信息                         |
   |          list           |                         交易信息列表                         |
   |          total          |                        交易条目总数量                        |
   |          type           |            交易类型，详见enum TxInfoType类型说明             |
   |         txhash          |                           交易哈希                           |
   |          time           |                            时间戳                            |
   |         amount          |                            交易额                            |
   |   TxInfoType_Unknown    |                             未知                             |
   |  TxInfoType_Originator  |                          交易发起方                          |
   |   TxInfoType_Receiver   |                          交易接收方                          |
   |     TxInfoType_Gas      |                          手续费奖励                          |
   |    TxInfoType_Award     |                           区块奖励                           |
   |    TxInfoType_Pledge    |                             质押                             |
   | TxInfoType_RedeemPledge |                           解除质押                           |



## 十一、获得交易详情接口（GetTxInfoDetailReq）

1. 请求

   ```
   message GetTxInfoDetailReq
   {
       string version 	= 1; 
       string txhash 	= 2; 
       string addr 	= 3; 
   }
   ```

   |  字段   |                    说明                    |
   | :-----: | :----------------------------------------: |
   | version |                   版本号                   |
   | txhash  |                  交易哈希                  |
   |  addr   | 地址，传空值则不会查询针对该地址的奖励信息 |

2. 响应

   ```
   message GetTxInfoDetailAck
   {
       string version 				= 1; 
       int32 code 					= 2; 
       string description 			= 3;
       string blockhash 			= 4; 
       uint32 blockheight 			= 5; 
       string txhash 				= 6;
       uint64 time 				= 7; 
       repeated string fromaddr 	= 8; 
       repeated string toaddr 		= 9; 
       string gas 					= 10; 
       string amount 				= 11;
       string awardGas 			= 12; 
       string awardAmount 			= 13;
   }
   ```

   |    字段     |                             说明                             |
   | :---------: | :----------------------------------------------------------: |
   |   version   |                            版本号                            |
   |    code     | 返回错误码 0 成功; -1 传入的交易哈希值为空; -2 获得区块错误; -3 获得区块信息错误 -4 区块错误; |
   | description |                         返回错误信息                         |
   |  blockhash  |                           区块哈希                           |
   | blockheight |                           区块高度                           |
   |   txhash    |                           交易哈希                           |
   |    time     |                            时间戳                            |
   |  fromaddr   |                           发起地址                           |
   |   toaddr    |                           接收地址                           |
   |     gas     |                         付出交易Gas                          |
   |   amount    |                            交易额                            |
   |  awardGas   |                         获得奖励Gas                          |
   | awardAmount |                           区块奖励                           |



##  十二、获得区块列表接口（GetBlockInfoListReq）

1. 请求

   ```
   message GetBlockInfoListReq
   {
       string version 				= 1;
       uint32 index 				= 2;
       uint32 count 				= 3;
   }
   ```

   |  字段   |  说明  |
   | :-----: | :----: |
   | version | 版本号 |
   |  index  |  索引  |
   |  count  |  数量  |

2. 响应

   ```
   message GetBlockInfoListAck
   {
       string version 				= 1; 
       int32 code 					= 2; 
       string description 			= 3;
       uint32 top 					= 4; 
       uint32 txcount 				= 5; 
       repeated BlockInfoItem list = 6; 
   }
   
   message BlockInfoItem
   {
       string blockhash 			= 1;
       uint32 blockheight 			= 2;
       uint64 time 				= 3;
       string txHash 				= 4;
       repeated string fromAddr 	= 5;
       repeated string toAddr 		= 6; 
       string amount  				= 7; 
   } 
   
   ```

   |    字段     |                             说明                             |
   | :---------: | :----------------------------------------------------------: |
   |   version   |                            版本号                            |
   |    code     | 返回错误码 0 成功; -1 版本不兼容; -2 读取数据失败; -3 获得区块高度失败; -4 获得交易数量失败; -5 获得交易数量失败; -6 保留; -7 获得区块哈希值错误; -8 获得区块错误 |
   | description |                         返回错误信息                         |
   |     top     |                            总高度                            |
   |   txcount   |                          总交易笔数                          |
   |    list     |                         区块信息列表                         |
   |  blockhash  |                           区块哈希                           |
   | blockheight |                           区块高度                           |
   |    time     |                            时间戳                            |
   |   txHash    |                           交易哈希                           |
   |  fromAddr   |                          发起方地址                          |
   |   toAddr    |                          接收方地址                          |
   |   amount    |                            交易额                            |



##  十三、获得区块详情请求（GetBlockInfoDetailReq）

1. 请求

   ```
   message GetBlockInfoDetailReq
   {
       string version 		= 1;
       string blockhash 	= 2;
   }
   ```

   |   字段    |   说明   |
   | :-------: | :------: |
   |  version  |  版本号  |
   | blockhash | 区块hash |

2. 响应

   ```
   message GetBlockInfoDetailAck
   {
       string version 								= 1;
       int32 code 									= 2; 
       string description 							= 3;
   
       string blockhash 							= 4;
       uint32 blockheight 							= 5;
       string merkleRoot 							= 6; 
       string prevHash 							= 7; 
       uint64 time 								= 8;
       string tatalAmount 							= 9; 
   
       repeated string signer 						= 10;
       repeated BlockInfoOutAddr blockInfoOutAddr	= 11;
   }
   
   message BlockInfoOutAddr
   {
       string addr 								= 1;
       string amount 								= 2; 
   }
   ```

   |       字段       |                             说明                             |
   | :--------------: | :----------------------------------------------------------: |
   |     version      |                            版本号                            |
   |       code       | 返回错误码  0 成功; -1 版本不兼容; -2 读取数据失败; -3 获得区块失败 |
   |   description    |                         返回错误信息                         |
   |    blockhash     |                           区块哈希                           |
   |   blockheight    |                           区块高度                           |
   |    merkleRoot    |                        Merkle树根哈希                        |
   |     prevHash     |                         前置区块哈希                         |
   |       time       |                            时间戳                            |
   |   tatalAmount    |                    交易总额,不包括手续费                     |
   |      signer      |                            签名者                            |
   | blockInfoOutAddr |                            交易额                            |
   |       addr       |                          接收方地址                          |
   |      amount      |                           接收金额                           |